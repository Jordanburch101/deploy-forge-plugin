# WordPress GitHub Auto-Deploy Plugin - Cursor Rules

## Project Context
This is a WordPress plugin that automates theme deployment from GitHub repositories. It handles webhooks, triggers GitHub Actions, polls for build completion, and deploys compiled theme files to WordPress.

## Core Architecture
- GitHub webhook → WordPress plugin → GitHub Actions → Build artifact → Deploy to theme directory
- Custom database tables for deployment history (NOT post types)
- REST API endpoints for webhooks with HMAC validation
- WP_Cron for polling build status

## Technology Stack Requirements

### PHP
- PHP 7.4+ minimum
- Use typed properties, arrow functions, null coalescing operator
- Follow WordPress Coding Standards
- Use WordPress native functions over external libraries
- NO Composer dependencies or autoloader
- NO external libraries - WordPress core only

### JavaScript
- Vanilla ES6+ only (Fetch API, async/await, Promises)
- NO jQuery plugins
- NO React, Vue, or any frameworks
- Use WordPress REST API for AJAX operations
- Modern async patterns only

### CSS
- WordPress admin styles as base
- Minimal custom CSS only
- Follow WordPress admin design patterns

### HTTP & APIs
- Use `wp_remote_request()` for all HTTP calls (NOT cURL, NOT file_get_contents)
- Use WordPress REST API for custom endpoints
- Use Transients API for caching (NOT wp_cache)
- Use WP_Cron for background jobs

### Database
- Use `wpdb` directly (NO ORMs, NO query builders)
- Custom tables with proper prefixes
- Prepared statements for all queries
- Follow WordPress database naming conventions

### File Operations
- Use `WP_Filesystem` API (NOT fopen, file_put_contents, etc.)
- Validate paths to prevent directory traversal
- Create backups before deployments

## Security Requirements (Critical)
- Check `manage_options` capability on ALL admin operations
- Use nonces on ALL forms and AJAX requests
- Sanitize ALL inputs with WordPress `sanitize_*()` functions
- Escape ALL outputs with WordPress `esc_*()` functions
- Encrypt GitHub tokens with `sodium_crypto_secretbox()`
- Validate webhook signatures with HMAC SHA256
- Rate limit webhook endpoint
- Never expose tokens in logs or error messages

## WordPress APIs to Use
- Settings API for options pages
- Transients API for caching GitHub responses
- WP_Cron for polling (NOT system cron)
- WP_Filesystem for file operations
- REST API for webhooks and AJAX
- Nonces for CSRF protection

## Project Scope

### IN SCOPE (v1.0)
- Single repository/branch connection
- Theme deployment only (NOT plugins)
- GitHub Actions integration
- Manual and webhook-triggered deploys
- Basic deployment history
- Rollback to previous version

### OUT OF SCOPE
- Plugin deployments
- Multiple repositories
- Multi-environment (staging/prod)
- Email/Slack notifications
- GitLab/Bitbucket support
- Deployment scheduling

## Code Organization
```
github-auto-deploy/
├── github-auto-deploy.php         # Main plugin file
├── includes/                      # Core classes
│   ├── class-database.php
│   ├── class-github-api.php
│   ├── class-deployment-manager.php
│   ├── class-webhook-handler.php
│   └── class-settings.php
├── admin/                         # Admin UI
│   ├── class-admin-pages.php
│   ├── css/admin-styles.css
│   └── js/admin-scripts.js
└── templates/                     # PHP templates
    ├── settings-page.php
    ├── dashboard-page.php
    └── history-page.php
```

## Class Structure
- One class per file
- Prefix: `GitHub_Auto_Deploy_`
- Use singleton pattern for managers
- Static utility methods where appropriate
- Proper constructor initialization

## Naming Conventions
- Classes: `GitHub_Auto_Deploy_Class_Name`
- Functions: `github_auto_deploy_function_name()`
- Hooks: `github_auto_deploy/hook_name`
- Database tables: `{prefix}_github_deployments`
- Options: `github_auto_deploy_option_name`
- Transients: `github_auto_deploy_transient_name`
- Nonces: `github_auto_deploy_nonce_action`

## Error Handling
- Use `WP_Error` for error returns
- Log errors with `error_log()` for debugging
- Store deployment errors in database
- Never expose sensitive data in errors
- Graceful degradation for failed operations

## Development Principles
1. **WordPress Native First**: Use built-in WordPress functions over external solutions
2. **No Build Process**: Plugin itself requires no compilation (themes may require builds)
3. **Maximum Compatibility**: Support WordPress 5.8+ and PHP 7.4+
4. **Security First**: Every operation must validate permissions and sanitize data
5. **Keep It Simple**: Avoid over-engineering, use WordPress conventions

## Common Patterns

### AJAX Handler Template
```php
public function handle_ajax_request() {
    check_ajax_referer('github_auto_deploy_nonce', 'nonce');
    
    if (!current_user_can('manage_options')) {
        wp_send_json_error('Insufficient permissions');
    }
    
    $input = sanitize_text_field($_POST['input']);
    
    // Process...
    
    wp_send_json_success($data);
}
```

### Database Query Template
```php
global $wpdb;
$table = $wpdb->prefix . 'github_deployments';

$results = $wpdb->get_results($wpdb->prepare(
    "SELECT * FROM {$table} WHERE status = %s ORDER BY deployed_at DESC LIMIT %d",
    $status,
    $limit
));
```

### GitHub API Call Template
```php
$response = wp_remote_request($url, [
    'method' => 'GET',
    'headers' => [
        'Authorization' => 'Bearer ' . $this->get_decrypted_token(),
        'Accept' => 'application/vnd.github.v3+json',
    ],
    'timeout' => 15,
]);

if (is_wp_error($response)) {
    return $response;
}
```

## Testing Requirements
- Test with WordPress 5.8+
- Test with PHP 7.4 and 8.x
- Test nonce validation
- Test permission checks
- Test webhook signature validation
- Test file operations with different permission sets
- Test error conditions and edge cases

## Package Manager
- Use pnpm for any Node.js dependencies in example workflows
- WordPress plugin itself has NO npm dependencies

## What NOT to Do
- ❌ Don't use jQuery plugins
- ❌ Don't use Composer or external PHP libraries
- ❌ Don't use cURL directly (use wp_remote_request)
- ❌ Don't use direct database writes without wpdb
- ❌ Don't use system cron (use WP_Cron)
- ❌ Don't skip capability checks
- ❌ Don't skip nonce verification
- ❌ Don't skip input sanitization
- ❌ Don't skip output escaping
- ❌ Don't hardcode paths (use WordPress constants)
- ❌ Don't expose tokens in logs or UI
- ❌ Don't create post types for deployments (use custom table)

## GitHub Integration
- Use Personal Access Token with `repo` and `actions` scopes
- Validate webhook signatures with HMAC SHA256
- Poll GitHub Actions API for build status
- Download artifacts via GitHub API
- Support GitHub Actions workflow dispatch

## Deployment Workflow
1. Validate webhook/manual trigger
2. Trigger GitHub Actions workflow
3. Poll for build completion (WP_Cron every minute)
4. Download build artifact
5. Create backup of current theme
6. Extract and deploy new files
7. Log deployment to database
8. Clean up temporary files

## When Generating Code
- Always include security checks (capabilities, nonces)
- Always sanitize inputs and escape outputs
- Use WordPress coding standards
- Add inline documentation for complex logic
- Include error handling with WP_Error
- Test with WordPress debug mode enabled

