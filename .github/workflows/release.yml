name: Release Plugin

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHPCS
        run: ./vendor/bin/phpcs --standard=phpcs.xml.dist

      - name: Run unit tests
        run: ./vendor/bin/phpunit

  integration:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      WP_DB_NAME: wordpress
      WP_DB_USER: root
      WP_DB_PASS: root
      WP_DB_HOST: 127.0.0.1
      WP_URL: http://localhost:8080
      WP_TITLE: "Test Site"
      WP_ADMIN_USER: admin
      WP_ADMIN_PASS: admin123
      WP_ADMIN_EMAIL: admin@example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.0 (minimum supported)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mysqli, zip, sodium
          coverage: none

      - name: Install WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp

      - name: Install WordPress
        run: |
          mkdir -p /tmp/wordpress
          cd /tmp/wordpress
          wp core download --version=latest
          wp config create \
            --dbname=$WP_DB_NAME \
            --dbuser=$WP_DB_USER \
            --dbpass=$WP_DB_PASS \
            --dbhost=$WP_DB_HOST
          wp core install \
            --url=$WP_URL \
            --title="$WP_TITLE" \
            --admin_user=$WP_ADMIN_USER \
            --admin_password=$WP_ADMIN_PASS \
            --admin_email=$WP_ADMIN_EMAIL \
            --skip-email
          wp config set WP_DEBUG true --raw
          wp config set WP_DEBUG_LOG true --raw
          echo "WordPress $(wp core version) installed"

      - name: Install and activate plugin
        run: |
          cp -r deploy-forge /tmp/wordpress/wp-content/plugins/deploy-forge
          wp plugin activate deploy-forge --path=/tmp/wordpress
          echo "Plugin activated successfully"

      - name: Check for PHP errors
        run: |
          wp eval "echo 'WordPress loaded OK';" --path=/tmp/wordpress

          LOG_FILE="/tmp/wordpress/wp-content/debug.log"
          if [ -f "$LOG_FILE" ] && grep -iE "(Fatal error|Parse error)" "$LOG_FILE"; then
            echo "FAIL: Fatal/parse errors found"
            cat "$LOG_FILE"
            exit 1
          fi
          echo "No fatal errors"

      - name: Verify database tables created
        run: |
          TABLE=$(wp db query "SHOW TABLES LIKE '%github_deployments';" --path=/tmp/wordpress 2>/dev/null)
          if [ -z "$TABLE" ]; then
            echo "FAIL: Deployment table was not created"
            exit 1
          fi
          echo "Database table created: $TABLE"

      - name: Verify admin pages load
        run: |
          cd /tmp/wordpress
          php -S localhost:8080 -t . &>/dev/null &
          sleep 2

          COOKIE_JAR=$(mktemp)
          curl -s -c "$COOKIE_JAR" "http://localhost:8080/wp-login.php" > /dev/null
          curl -s -b "$COOKIE_JAR" -c "$COOKIE_JAR" \
            -d "log=$WP_ADMIN_USER&pwd=$WP_ADMIN_PASS&wp-submit=Log+In&redirect_to=%2Fwp-admin%2F&testcookie=1" \
            -L "http://localhost:8080/wp-login.php" > /dev/null

          ERRORS=0
          for PAGE in "admin.php?page=deploy-forge" "admin.php?page=deploy-forge-settings" "admin.php?page=deploy-forge-logs"; do
            HTTP_CODE=$(curl -s -o /tmp/page-output.html -w "%{http_code}" \
              -b "$COOKIE_JAR" "http://localhost:8080/wp-admin/$PAGE")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "FAIL: $PAGE returned HTTP $HTTP_CODE"
              ERRORS=$((ERRORS + 1))
            elif grep -qi "Fatal error\|Parse error\|Call to undefined" /tmp/page-output.html; then
              echo "FAIL: PHP error in $PAGE"
              ERRORS=$((ERRORS + 1))
            else
              echo "OK: $PAGE"
            fi
          done

          if [ $ERRORS -gt 0 ]; then exit 1; fi
          echo "All admin pages loaded successfully"

      - name: Verify clean deactivation and re-activation
        run: |
          wp plugin deactivate deploy-forge --path=/tmp/wordpress
          wp plugin activate deploy-forge --path=/tmp/wordpress
          wp eval "echo 'Re-activation OK';" --path=/tmp/wordpress

  release:
    needs: [lint-and-test, integration]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag format
        id: validate
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Validating tag: $TAG"

          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Tag must match v*.*.* format (e.g., v1.0.0)"
            echo "   Received: $TAG"
            exit 1
          fi

          VERSION=${TAG#v}
          echo "âœ… Valid tag format"
          echo "   Tag: $TAG"
          echo "   Version: $VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist

      - name: Verify version in plugin file
        run: |
          echo "Checking version in deploy-forge/deploy-forge.php..."
          FILE_VERSION=$(grep -oP "Version:\s*\K[0-9]+\.[0-9]+\.[0-9]+" deploy-forge/deploy-forge.php)
          TAG_VERSION="${{ steps.validate.outputs.version }}"

          echo "  Plugin file version: $FILE_VERSION"
          echo "  Git tag version: $TAG_VERSION"

          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo ""
            echo "âŒ Error: Version mismatch detected!"
            echo ""
            echo "  The version in deploy-forge/deploy-forge.php ($FILE_VERSION) does not match"
            echo "  the git tag version ($TAG_VERSION)."
            echo ""
            echo "  Please update the version in deploy-forge/deploy-forge.php and try again:"
            echo "  1. Edit deploy-forge/deploy-forge.php"
            echo "  2. Change 'Version: $FILE_VERSION' to 'Version: $TAG_VERSION'"
            echo "  3. Commit: git commit -am \"Update version to $TAG_VERSION\""
            echo "  4. Move tag: git tag -f ${{ steps.validate.outputs.tag }}"
            echo "  5. Push: git push -f origin ${{ steps.validate.outputs.tag }}"
            echo ""
            exit 1
          fi

          echo "âœ… Version matches git tag"

      - name: Build plugin ZIP
        run: |
          echo "Building plugin ZIP..."
          chmod +x build.sh
          ./build.sh

          echo ""
          echo "ğŸ“¦ Build output:"
          ls -lh dist/

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          CHANGELOG_FILE="CHANGELOG.md"

          if [ -f "$CHANGELOG_FILE" ]; then
            echo "Extracting changelog from $CHANGELOG_FILE..."

            # Extract section for this version
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" $CHANGELOG_FILE | sed '$ d' || echo "")

            if [ -z "$CHANGELOG" ]; then
              echo "âš ï¸  No changelog found for version $VERSION in $CHANGELOG_FILE"
              CHANGELOG="Release version $VERSION"
            else
              echo "âœ… Changelog extracted"
            fi
          else
            echo "â„¹ï¸  No CHANGELOG.md found, using default release notes"
            CHANGELOG="Release version $VERSION"
          fi

          # Write to output using heredoc to handle multiline
          {
            echo "notes<<EOF"
            echo "$CHANGELOG"
            echo ""
            echo "---"
            echo ""
            echo "**Installation:**"
            echo "1. Download \`deploy-forge-$VERSION.zip\`"
            echo "2. Go to WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin"
            echo "3. Upload the ZIP file and activate"
            echo ""
            echo "**Update Server:** This release will be automatically available to existing installations via the Deploy Forge update server."
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/deploy-forge-${{ steps.validate.outputs.version }}.zip
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
          tag_name: ${{ steps.validate.outputs.tag }}
          name: Version ${{ steps.validate.outputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Invalidate update server cache
        if: success()
        continue-on-error: true
        run: |
          echo "Notifying update server of new release..."

          # Only attempt if UPDATE_SERVER_URL secret is set
          if [ -n "${{ secrets.UPDATE_SERVER_URL }}" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"action":"published","release":{"tag_name":"${{ steps.validate.outputs.tag }}"}}' \
              ${{ secrets.UPDATE_SERVER_URL }}/api/cache/invalidate \
              || echo "âš ï¸  Failed to notify update server (non-fatal)"
          else
            echo "â„¹ï¸  UPDATE_SERVER_URL not configured, skipping cache invalidation"
          fi

      - name: Release Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Release ${{ steps.validate.outputs.tag }} Created Successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Release Details:"
          echo "   Version: ${{ steps.validate.outputs.version }}"
          echo "   Tag: ${{ steps.validate.outputs.tag }}"
          echo "   ZIP: deploy-forge-${{ steps.validate.outputs.version }}.zip"
          echo ""
          echo "ğŸ”— Release URL:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/${{ steps.validate.outputs.tag }}"
          echo ""
          echo "ğŸ“¥ Download URL:"
          echo "   https://github.com/${{ github.repository }}/releases/download/${{ steps.validate.outputs.tag }}/deploy-forge-${{ steps.validate.outputs.version }}.zip"
          echo ""
          echo "âœ¨ Next Steps:"
          echo "   1. WordPress sites will be notified of the update automatically"
          echo "   2. Update server will serve this version to authorized sites"
          echo "   3. Users can update via WordPress admin â†’ Plugins page"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
